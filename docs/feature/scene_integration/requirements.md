# 场景集成需求

版本：v0.1（2025-12-25）

## 目标
- 允许用户以 JSON 自定义场景（含名称、描述、步骤与顺序）。
- 支持场景复用（场景中引用场景），但必须禁止循环嵌套。
- 通过 API 动态增删改场景，并将更新持久化到配置文件。
- Agent 能获取场景列表并在执行计划中选择场景。
- 执行场景时支持“等待设备达到状态”的依赖关系；超时则中止场景并返回原因。

## 功能需求
1) 场景配置
- 场景定义采用 JSON 文件（`scenes.json`）。
- 场景文件与设备配置文件放在同一目录，便于用户集中管理。
- 场景包含 `id/name/description/steps`；`steps` 有序。

2) 步骤类型
- 设备动作：`type=device`，包含 `deviceId/action/params`。
- 场景引用：`type=scene`，包含 `sceneId`。
- 设备动作支持 `wait_for`：在动作下发后等待设备状态满足条件，再继续下一步。

3) 等待条件
- `wait_for` 至少包含：`traitPath/operator/value/timeoutMs`。
- 可选：`pollMs`（轮询间隔）、`on_timeout`（超时策略）。
- 当前仅支持 `on_timeout=abort`：超时立即中止场景并返回原因。

4) 场景嵌套校验
- 场景引用必须存在。
- 禁止循环嵌套（A 引 B，B 引 A 或更长环）。
- 校验失败时拒绝保存/执行场景。

5) API 动态更新
- 提供场景增删改查 API，支持 App 编辑场景并持久化到文件。
- 更新应保持顺序与结构不变，且写入要可恢复（避免半写入）。
- 删除场景需先检查依赖：无依赖可直接删除；有依赖需显式级联删除。

6) MCP + Agent
- MCP 新增场景列表工具，仅返回 `id/name/description`。
- Agent 启动/每轮将场景列表与设备列表一并注入上下文。
- Agent 的执行队列支持 `type=scene`。

7) 执行与结果
- 执行队列支持场景展开：将引用场景递归展开为设备动作序列。
- 执行动作时严格按顺序执行；遇到 `wait_for` 需满足条件再继续。
- 超时中止场景，并向用户返回明确原因（包含设备、条件、超时信息）。

## 兼容性
- 不破坏现有设备控制、规则引擎与 Agent 的基础流程。
- 场景能力可逐步扩展（如并发、延时、条件分支等）。
