# Smart House Agent – 需求

版本：v0.1（2025-12-17）

## 1. 背景与动机
当前系统已具备：
- 设备归一化与动作下发：`device-adapter`（Zigbee2MQTT/HA）+ Redis 总线
- 对外 API 与 WS：`api-gateway`
- 确定性联动：`rules-engine`
- LLM 代理/意图接口：`llm-bridge`（保持保留）

但“单次意图解析”存在天然上限：难以处理多设备协同、需要状态信息的问答、长对话上下文、以及不确定时的追问确认。Smart House Agent 的目标是把 LLM 升级为“可调用工具的规划/执行器”，并用工程化的安全门禁保证可控。

## 2. 范围（Scope）
### 2.1 必须支持（MVP→长期都成立的核心能力）
- **自然语言任务**：支持命令、问答、混合任务（先问再做/边问边做）。
- **多设备/多步**：一个请求可生成并执行多个动作（例如“我要睡觉了”：关灯、关窗帘、打开空调睡眠模式）。
- **状态驱动**：能基于实时状态回答（例如“水在烧了么”“客厅灯开着吗”“今天耗电多少”）。
- **会话上下文**：在一个会话周期内保留历史与用户偏好（代词/省略/上下文引用）。
- **不确定时追问**：无法唯一确定设备/动作/参数时，必须提出澄清问题并给出候选项（而不是盲目执行）。
- **安全执行**：写操作需通过策略/权限门禁；支持“预览计划（dry-run）→确认→执行”。
- **工具调用（MCP）**：通过 MCP 暴露工具给 Agent 使用（并可扩展多个工具服务器）。
- **审计与可观测**：每次工具调用/执行动作可追踪、可回放、可统计。

### 2.2 明确不做（短期非目标）
- **让 LLM 直接访问底层 MQTT/串口**：所有外部副作用统一走受控工具/API（避免绕过策略）。
- **纯开放式自动化**：长期可支持自动规划，但默认仍以用户触发为主，自动化交给 `rules-engine`。
- **把 LLM 当唯一真相来源**：事实必须来自工具（设备列表/状态/历史），LLM 只做推理与规划。

## 3. 角色与体验
- **普通用户（语音/文本）**：希望用自然语言完成控制与问答，能解释“为什么这么做”，并可随时取消。
- **管理员/开发者**：希望可配置权限、可扩展工具、可回归测试，且可观察每次执行路径。

体验目标（示例）
- “我要睡觉了” → 返回计划预览（可选自动确认策略），执行后汇报结果与失败项。
- “水在烧了么” → 首先查询插座状态/功率（若无功率传感器则明确局限），再回答。
- “把它关掉” → 基于会话中的最近目标与房间上下文做解析，不确定则追问“你指的是…吗？”。

## 4. 功能需求（Functional）
### 4.1 会话与上下文
- 支持 `sessionId`（客户端传入或由服务生成），可设置 TTL。
- 记忆类型：
  - 短期：最近 N 轮对话与最近一次执行计划/目标设备
  - 中期：本次会话偏好（例如“默认关客厅所有灯”）
  - 长期（可选）：用户画像与家居偏好（需隐私/授权）

### 4.2 设备与状态
- 可获取设备列表、按房间/标签/别名搜索。
- 可获取单设备与批量设备状态（traits），并能订阅状态变化（WS/事件流）。
- 能感知设备能力（capabilities）与参数 schema，用于约束动作与校验参数。

### 4.3 规划（Planning）
输出必须包含：
- `planId`（可追踪）
- `type`：`query | propose | execute | clarify`
- `steps[]`：每步的目标、依赖、风险等级、回滚策略（若适用）
- `actions[]`：可执行动作列表（设备、动作、参数、前置条件）
- `explanation`：面向用户的解释（简短）

### 4.4 执行（Execution）
执行策略：
- 支持串行/并行（按依赖与设备类型）。
- 支持等待动作回执与超时，汇总成功/失败原因。
- 支持取消（对未执行步骤/可取消步骤生效）。
- 支持回滚（在能力允许时，如“关灯失败→重试/恢复上一步状态”）。

### 4.5 澄清与确认
- 当出现以下情况必须澄清而非执行：
  - 设备候选不唯一且影响面较大
  - 动作/参数不完整或超出能力范围
  - 语义是问答而非控制（例如“水在烧了么”）
- 写操作默认要求确认；可配置低风险自动确认（例如“关闭我刚打开的设备”）。

## 5. 非功能需求（Non-Functional）
- **安全**：最小权限、分级授权（read vs write）、审计与可追溯、速率限制、防提示注入。
- **可靠性**：工具调用失败要降级/重试，保证“解释清楚 + 不误执行”。
- **延迟**：常见控制任务需低延迟（语音场景），但允许复杂任务多轮。
- **可移植**：本地优先，支持 docker-compose；未来可迁移到 K8s。
- **可测性**：必须可在无真实设备时通过 mock/sim 重放对话与工具结果。

## 6. 约束与兼容
- 保留现有 `llm-bridge`，Agent 为新入口服务。
- 设备事实来源以 `api-gateway`/`device-adapter` 为准；不得直接绕过总线写 MQTT（除非作为受控工具的一部分）。

