openapi: 3.1.0
info:
  title: LocalLLMSmartHouse Gateway API
  version: 0.1.0
  description: REST surface of the API Gateway. WebSocket updates at `/ws` (not modeled here).
servers:
  - url: http://localhost:4000
    description: Local dev (compose)
components:
  securitySchemes:
    ApiKey:
      type: apiKey
      in: header
      name: X-API-Key
  schemas:
    Device:
      type: object
      required:
        - id
        - name
        - placement
        - protocol
        - bindings
        - traits
        - capabilities
      properties:
        id:
          type: string
        name:
          type: string
        placement:
          $ref: "#/components/schemas/Placement"
        protocol:
          type: string
          enum: [zigbee, wifi, bluetooth_mesh, matter, virtual]
        bindings:
          type: object
        traits:
          type: object
        capabilities:
          type: array
          items:
            $ref: "#/components/schemas/Capability"
        semantics:
          type: object
    Placement:
      type: object
      properties:
        room:
          type: string
        zone:
          type: string
        floor:
          type: string
        mount:
          type: string
        description:
          type: string
    Capability:
      type: object
      required: [action]
      properties:
        action:
          type: string
        description:
          type: string
        parameters:
          type: array
          items:
            $ref: "#/components/schemas/CapabilityParameter"
    CapabilityParameter:
      type: object
      required: [name, type]
      properties:
        name:
          type: string
        type:
          type: string
          enum: [boolean, number, string, enum]
        minimum:
          type: number
        maximum:
          type: number
        enum:
          type: array
          items:
            type: string
        required:
          type: boolean
    ActionResult:
      type: object
      properties:
        id:
          type: string
        deviceId:
          type: string
        action:
          type: string
        status:
          type: string
        transport:
          type: string
        reason:
          type: string
        params:
          type: object
        createdAt:
          type: string
          format: date-time
    Rule:
      type: object
      required: [id, when, then]
      properties:
        id:
          type: string
        name:
          type: string
        when:
          type: object
          properties:
            deviceId:
              type: string
            traitPath:
              type: string
            equals:
              description: Value to compare at traitPath
              oneOf:
                - type: string
                - type: number
                - type: boolean
        then:
          type: object
          properties:
            action:
              type: string
            params:
              type: object
        enabled:
          type: boolean
    Point2D:
      type: object
      required: [x, y]
      properties:
        x:
          type: number
        y:
          type: number
    Point3D:
      type: object
      required: [x, y, z]
      properties:
        x:
          type: number
        y:
          type: number
        z:
          type: number
    ModelTransform:
      type: object
      required: [matrix, translate]
      properties:
        matrix:
          type: array
          minItems: 4
          maxItems: 4
          items:
            type: number
          description: Row-major 2x2 matrix mapping 2D to 3D (x/z).
        translate:
          type: object
          required: [x, z]
          properties:
            x:
              type: number
            z:
              type: number
    CalibrationPoints:
      type: object
      required: [image, model]
      properties:
        image:
          type: array
          minItems: 3
          maxItems: 3
          items:
            $ref: "#/components/schemas/Point2D"
        model:
          type: array
          minItems: 3
          maxItems: 3
          items:
            $ref: "#/components/schemas/Point3D"
    FloorplanAsset:
      type: object
      required: [assetId, url]
      properties:
        assetId:
          type: string
        url:
          type: string
        mime:
          type: string
        size:
          type: integer
        width:
          type: integer
        height:
          type: integer
    FloorplanRoom:
      type: object
      required: [id, name, polygon]
      properties:
        id:
          type: string
        name:
          type: string
        polygon:
          type: array
          minItems: 3
          items:
            $ref: "#/components/schemas/Point2D"
    FloorplanDevice:
      type: object
      required: [deviceId, x, y]
      properties:
        deviceId:
          type: string
        x:
          type: number
        y:
          type: number
        height:
          type: number
        rotation:
          type: number
        scale:
          type: number
        roomId:
          type: string
    Floorplan:
      type: object
      required: [id, name, image, rooms, devices]
      properties:
        id:
          type: string
        name:
          type: string
        image:
          $ref: "#/components/schemas/FloorplanAsset"
        model:
          $ref: "#/components/schemas/FloorplanAsset"
        modelTransform:
          $ref: "#/components/schemas/ModelTransform"
        calibrationPoints:
          $ref: "#/components/schemas/CalibrationPoints"
        rooms:
          type: array
          items:
            $ref: "#/components/schemas/FloorplanRoom"
        devices:
          type: array
          items:
            $ref: "#/components/schemas/FloorplanDevice"
    FloorplanSummary:
      type: object
      required: [id, name, image]
      properties:
        id:
          type: string
        name:
          type: string
        image:
          $ref: "#/components/schemas/FloorplanAsset"
        model:
          $ref: "#/components/schemas/FloorplanAsset"
        roomCount:
          type: integer
        deviceCount:
          type: integer
    AssetUploadResponse:
      type: object
      required: [assetId, url, kind]
      properties:
        assetId:
          type: string
        url:
          type: string
        kind:
          type: string
          enum: [floorplan_image, floorplan_model]
        mime:
          type: string
        size:
          type: integer
        width:
          type: integer
        height:
          type: integer
    VirtualSimulatorDefaults:
      type: object
      required: [latency_ms, failure_rate]
      properties:
        latency_ms:
          type: integer
          minimum: 0
        failure_rate:
          type: number
          minimum: 0
          maximum: 1
    VirtualDevice:
      type: object
      required: [id, name, placement, protocol, bindings, traits, capabilities]
      properties:
        id:
          type: string
        name:
          type: string
        placement:
          $ref: "#/components/schemas/Placement"
        protocol:
          type: string
          example: virtual
        bindings:
          type: object
        traits:
          type: object
        capabilities:
          type: array
          items:
            $ref: "#/components/schemas/Capability"
        semantics:
          type: object
        simulation:
          type: object
          properties:
            latency_ms:
              type: integer
              minimum: 0
            failure_rate:
              type: number
              minimum: 0
              maximum: 1
            transitions:
              type: object
    VirtualDevicesConfig:
      type: object
      required: [enabled, defaults, devices]
      properties:
        enabled:
          type: boolean
        defaults:
          $ref: "#/components/schemas/VirtualSimulatorDefaults"
        devices:
          type: array
          items:
            $ref: "#/components/schemas/VirtualDevice"
    VirtualDevicesConfigUpdate:
      type: object
      properties:
        enabled:
          type: boolean
        defaults:
          $ref: "#/components/schemas/VirtualSimulatorDefaults"
        devices:
          type: array
          items:
            $ref: "#/components/schemas/VirtualDevice"
    SceneRunRequest:
      type: object
      properties:
        dryRun:
          type: boolean
          default: false
        confirm:
          type: boolean
          default: false
        requestId:
          type: string
        timeoutMs:
          type: integer
          minimum: 1
    SceneRunStepResult:
      type: object
      required: [index, deviceId, action, status]
      properties:
        index:
          type: integer
        deviceId:
          type: string
        action:
          type: string
        status:
          type: string
          enum: [queued, ok, error, timeout, dry_run]
        reason:
          type: string
        transport:
          type: string
        params:
          type: object
        startedAt:
          type: integer
        endedAt:
          type: integer
    SceneRunResult:
      type: object
      required: [runId, sceneId, status, steps, startedAt]
      properties:
        runId:
          type: string
        sceneId:
          type: string
        status:
          type: string
          enum: [running, ok, partial_ok, error, timeout]
        steps:
          type: array
          items:
            $ref: "#/components/schemas/SceneRunStepResult"
        startedAt:
          type: integer
        endedAt:
          type: integer
        durationMs:
          type: integer
paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
  /devices:
    get:
      summary: List devices
      security:
        - ApiKey: []
      responses:
        "200":
          description: Device list
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Device"
                  count:
                    type: integer
  /devices/{id}:
    get:
      summary: Get a device
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Device
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Device"
        "404":
          description: Not found
  /devices/{id}/actions:
    get:
      summary: List action results for a device
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: Action results
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/ActionResult"
                  limit:
                    type: integer
                  offset:
                    type: integer
        "404":
          description: Device not found
    post:
      summary: Enqueue an action for a device
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                params:
                  type: object
      responses:
        "200":
          description: Queued
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: queued
        "400":
          description: Invalid params or action not supported
        "404":
          description: Device not found
        "503":
          description: Bus unavailable
  /rules:
    get:
      summary: List rules
      security:
        - ApiKey: []
      responses:
        "200":
          description: Rules
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Rule"
    post:
      summary: Create a rule
      security:
        - ApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Rule"
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Rule"
        "400":
          description: Invalid rule
        "503":
          description: Rule store unavailable
  /rules/{id}:
    get:
      summary: Get a rule
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Rule
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Rule"
        "404":
          description: Not found
    put:
      summary: Update a rule
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Rule"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Rule"
    delete:
      summary: Delete a rule
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: deleted
  /floorplans:
    get:
      summary: List floorplans
      security:
        - ApiKey: []
      responses:
        "200":
          description: Floorplan list
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/FloorplanSummary"
                  count:
                    type: integer
    post:
      summary: Create a floorplan
      security:
        - ApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Floorplan"
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Floorplan"
        "400":
          description: Invalid floorplan
        "409":
          description: Floorplan already exists
        "503":
          description: Floorplan store unavailable
  /floorplans/{id}:
    get:
      summary: Get a floorplan
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Floorplan
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Floorplan"
        "404":
          description: Not found
    put:
      summary: Update a floorplan
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Floorplan"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Floorplan"
        "400":
          description: Invalid floorplan
        "404":
          description: Not found
    delete:
      summary: Delete a floorplan
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: deleted
        "404":
          description: Not found
  /assets:
    post:
      summary: Upload an asset
      security:
        - ApiKey: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [kind, file]
              properties:
                kind:
                  type: string
                  enum: [floorplan_image, floorplan_model]
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: Uploaded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AssetUploadResponse"
        "400":
          description: Invalid asset
        "413":
          description: Payload too large
        "415":
          description: Unsupported media type
  /scenes/{id}/run:
    post:
      summary: Run a scene and return aggregated step results
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SceneRunRequest"
      responses:
        "200":
          description: Run completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SceneRunResult"
        "400":
          description: Invalid request or confirmation required
        "404":
          description: Scene not found
        "503":
          description: Scene run unavailable
  /virtual-devices/config:
    get:
      summary: Get virtual simulator config from devices.config.json
      security:
        - ApiKey: []
      responses:
        "200":
          description: Virtual devices config
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VirtualDevicesConfig"
        "503":
          description: Virtual device store unavailable
    put:
      summary: Update virtual simulator config
      security:
        - ApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VirtualDevicesConfigUpdate"
      responses:
        "200":
          description: Updated virtual devices config
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VirtualDevicesConfig"
        "400":
          description: Invalid virtual config
        "503":
          description: Virtual device store unavailable
  /virtual-devices/{id}:
    put:
      summary: Upsert one virtual device
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VirtualDevice"
      responses:
        "200":
          description: Upserted virtual device
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VirtualDevice"
        "400":
          description: Invalid virtual config
        "503":
          description: Virtual device store unavailable
    delete:
      summary: Delete one virtual device
      security:
        - ApiKey: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: deleted
                  removed:
                    type: string
        "404":
          description: Virtual device not found
        "503":
          description: Virtual device store unavailable
