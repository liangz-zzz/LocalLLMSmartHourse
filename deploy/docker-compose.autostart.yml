services:
  api-gateway:
    user: "0:0"
    command:
      - bash
      - -lc
      - |
          set -euo pipefail
          cd /app
          mkdir -p /app/node_modules
          chown -R node:node /app/node_modules
          su node -c "cd /app && npm ci"
          until (echo > /dev/tcp/db/5432) >/dev/null 2>&1; do echo "[api-gateway] waiting for db:5432"; sleep 1; done
          su node -c "cd /app && npm run prisma:generate && npm run prisma:push"
          exec su node -c "cd /app && npm run dev"

  device-adapter:
    user: "0:0"
    command:
      - bash
      - -lc
      - |
          set -euo pipefail
          cd /app
          mkdir -p /app/node_modules
          chown -R node:node /app/node_modules
          su node -c "cd /app && npm ci"
          mode="${MODE:-mqtt}"
          if [ "${mode}" = "mqtt" ]; then
            until (echo > /dev/tcp/mqtt/1883) >/dev/null 2>&1; do echo "[device-adapter] waiting for mqtt:1883"; sleep 1; done
          fi
          if [ "${mode}" = "ha" ]; then
            until (echo > /dev/tcp/homeassistant/8123) >/dev/null 2>&1; do echo "[device-adapter] waiting for homeassistant:8123"; sleep 1; done
          fi
          exec su node -c "cd /app && npm run dev"

  device-simulator:
    user: "0:0"
    command:
      - bash
      - -lc
      - |
          set -euo pipefail
          cd /app
          mkdir -p /app/node_modules
          chown -R node:node /app/node_modules
          su node -c "cd /app && npm install"
          until (echo > /dev/tcp/redis/6379) >/dev/null 2>&1; do echo "[device-simulator] waiting for redis:6379"; sleep 1; done
          exec su node -c "cd /app && npm run dev"

  llm-bridge:
    user: "0:0"
    command:
      - bash
      - -lc
      - |
          set -euo pipefail
          cd /app
          mkdir -p /app/node_modules
          chown -R node:node /app/node_modules
          su node -c "cd /app && npm ci"
          exec su node -c "cd /app && npm run dev"

  smart-house-mcp-server:
    user: "0:0"
    command:
      - bash
      - -lc
      - |
          set -euo pipefail
          cd /app
          mkdir -p /app/node_modules
          chown -R node:node /app/node_modules
          su node -c "cd /app && npm ci"
          until curl -fsS --max-time 2 http://api-gateway:4000/health >/dev/null 2>&1; do echo "[smart-house-mcp-server] waiting for api-gateway:4000"; sleep 1; done
          exec su node -c "cd /app && npm run dev"

  smart-house-agent:
    user: "0:0"
    command:
      - bash
      - -lc
      - |
          set -euo pipefail
          cd /app
          mkdir -p /app/node_modules
          chown -R node:node /app/node_modules
          su node -c "cd /app && npm ci"
          until curl -fsS --max-time 2 http://llm-bridge:5000/health >/dev/null 2>&1; do echo "[smart-house-agent] waiting for llm-bridge:5000"; sleep 1; done
          until curl -fsS --max-time 2 http://smart-house-mcp-server:7000/health >/dev/null 2>&1; do echo "[smart-house-agent] waiting for smart-house-mcp-server:7000"; sleep 1; done
          exec su node -c "cd /app && npm run dev"

  rules-engine:
    user: "0:0"
    command:
      - bash
      - -lc
      - |
          set -euo pipefail
          cd /app
          mkdir -p /app/node_modules
          chown -R node:node /app/node_modules
          su node -c "cd /app && npm ci"
          until (echo > /dev/tcp/redis/6379) >/dev/null 2>&1; do echo "[rules-engine] waiting for redis:6379"; sleep 1; done
          exec su node -c "cd /app && npm run dev"

  voice-satellite:
    user: "${LOCAL_UID:-1000}:${LOCAL_GID:-1000}"
    command:
      - bash
      - -lc
      - |
          set -euo pipefail
          cd /app
          if [ ! -f /app/config.yaml ]; then
            echo "[voice-satellite] missing /app/config.yaml (copy config.example.yaml -> config.yaml and mount model files)"
            exec sleep infinity
          fi
          exec /app/run.sh --config /app/config.yaml
